<config>
  <synKH   >
    --- 1
    (SELECT
    B.KEY_TRANSACTION_ID,B.KEY_VERSION,B.TEN_CONG_CU AS TEN_TS,B.DVT,
    B.DON_GIA,B.DIEN_GIAI
    ,0 TY_LE_KHAU_HAO,'' LOAI_TAI_SAN,'' DOI_TUONG_SU_DUNG,
    (SK.[DATE] + CONVERT(DATETIME,SK.[TIME])) DATE ,
    CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS
    ,SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER,
    'HS' USE_BRANCH
    FROM
    DANH_MUC_CONG_CU_LAO_DONG_HS_MAIN B
    -- SELECT * FROM DANH_MUC_CONG_CU_LAO_DONG_HS_MAIN
    -- 56 record
    LEFT  JOIN
    (
    select  A.KEY_TRANSACTION_ID, MAX(A.KEY_VERSION) AS MAXX  from DANH_MUC_CONG_CU_LAO_DONG_HS_TRANSACTION A
    where STATUS = N'Đã duyệt' and A.KEY_TRANSACTION_ID = '201201'
    group by A.KEY_TRANSACTION_ID
    ) AS SQ ON SQ.KEY_TRANSACTION_ID = B.KEY_TRANSACTION_ID
    --where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    -- lay them thong tin tu bang tran nhung left join lai 56x4 record
    inner join
    (
    select top 1   A.KEY_TRANSACTION_ID,A.KEY_VERSION,DATE,TIME,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER  from DANH_MUC_CONG_CU_LAO_DONG_HS_TRANSACTION A
    -- 224 thanh 168 record neu co where
    where  A.KEY_TRANSACTION_ID = '201201'and STATUS = N'Đã duyệt'
    ) SK ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID AND SK.KEY_VERSION = SQ.MAXX
    where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201')
    --- 2
    union ALL
    (SELECT
    B.KEY_TRANSACTION_ID,B.KEY_VERSION,B.TEN_CONG_CU AS TEN_TS,B.DVT,
    B.DON_GIA,B.DIEN_GIAI
    ,0 TY_LE_KHAU_HAO,'' LOAI_TAI_SAN,'' DOI_TUONG_SU_DUNG,
    (SK.[DATE] + CONVERT(DATETIME,SK.[TIME])) DATE ,
    CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS
    ,SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER,
    'CN' USE_BRANCH
    FROM
    DANH_MUC_CONG_CU_LAO_DONG_MAIN B
    -- 56 record
    LEFT  JOIN
    (
    select  A.KEY_TRANSACTION_ID, MAX(A.KEY_VERSION) AS MAXX  from DANH_MUC_CONG_CU_LAO_DONG_TRANSACTION A
    where STATUS = N'Đã duyệt' and A.KEY_TRANSACTION_ID = '201201'
    group by A.KEY_TRANSACTION_ID
    ) AS SQ ON SQ.KEY_TRANSACTION_ID = B.KEY_TRANSACTION_ID
    --where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    -- lay them thong tin tu bang tran nhung left join lai 56x4 record
    inner join
    (
    select top 1   A.KEY_TRANSACTION_ID,A.KEY_VERSION,DATE,TIME,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER  from DANH_MUC_CONG_CU_LAO_DONG_TRANSACTION A
    -- 224 thanh 168 record neu co where
    where  A.KEY_TRANSACTION_ID = '201201'and STATUS = N'Đã duyệt'
    ) SK ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID AND SK.KEY_VERSION = SQ.MAXX
    where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    )
    --- 3
    union ALL
    (SELECT
    B.KEY_TRANSACTION_ID,B.KEY_VERSION,B.TEN_TAI_SAN AS TEN_TS,B.DVT,
    B.DON_GIA,B.DIEN_GIAI
    ,0 TY_LE_KHAU_HAO,'' LOAI_TAI_SAN,'' DOI_TUONG_SU_DUNG
    ,(SK.[DATE] + CONVERT(DATETIME,SK.[TIME])) DATE , CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS
    ,SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER,
    'HS' USE_BRANCH
    FROM
    DANH_MUC_TAI_SAN_CO_DINH_HS_MAIN B
    -- SELECT * FROM DANH_MUC_TAI_SAN_CO_DINH_HS_MAIN
    -- 56 record
    LEFT  JOIN
    (
    select  A.KEY_TRANSACTION_ID, MAX(A.KEY_VERSION) AS MAXX  from DANH_MUC_TAI_SAN_CO_DINH_HS_TRANSACTION A
    where STATUS = N'Đã duyệt' and A.KEY_TRANSACTION_ID = '201201'
    group by A.KEY_TRANSACTION_ID
    ) AS SQ ON SQ.KEY_TRANSACTION_ID = B.KEY_TRANSACTION_ID
    --where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    -- lay them thong tin tu bang tran nhung left join lai 56x4 record
    inner join
    (
    select   A.KEY_TRANSACTION_ID,A.KEY_VERSION,DATE,TIME,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER  from DANH_MUC_TAI_SAN_CO_DINH_HS_TRANSACTION A
    -- 224 thanh 168 record neu co where
    where  A.KEY_TRANSACTION_ID = '201201'and STATUS = N'Đã duyệt'
    ) SK ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID AND SK.KEY_VERSION = SQ.MAXX
    where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    )
    --- 4
    union ALL
    (SELECT
    B.KEY_TRANSACTION_ID,B.KEY_VERSION,B.TEN_TAI_SAN AS TEN_TS,B.DVT,
    B.DON_GIA,B.DIEN_GIAI
    ,0 TY_LE_KHAU_HAO,B.LOAI_TAI_SAN,B.DOI_TUONG_SU_DUNG
    ,(SK.[DATE] + CONVERT(DATETIME,SK.[TIME])) DATE ,
    CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS
    ,SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER,
    'HS' USE_BRANCH
    FROM
    DANH_MUC_TAI_SAN_CO_DINH_MAIN B
    -- SELECT * FROM DANH_MUC_TAI_SAN_CO_DINH_MAIN
    -- 56 record
    LEFT  JOIN
    (
    select  A.KEY_TRANSACTION_ID, MAX(A.KEY_VERSION) AS MAXX  from DANH_MUC_TAI_SAN_CO_DINH_TRANSACTION A
    where STATUS = N'Đã duyệt' and A.KEY_TRANSACTION_ID = '201201'
    group by A.KEY_TRANSACTION_ID
    ) AS SQ ON SQ.KEY_TRANSACTION_ID = B.KEY_TRANSACTION_ID
    --where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    -- lay them thong tin tu bang tran nhung left join lai 56x4 record
    inner join
    (
    select   A.KEY_TRANSACTION_ID,A.KEY_VERSION,DATE,TIME,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER  from DANH_MUC_TAI_SAN_CO_DINH_TRANSACTION A
    -- 224 thanh 168 record neu co where
    where  A.KEY_TRANSACTION_ID = '201201'and STATUS = N'Đã duyệt'
    ) SK ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID AND SK.KEY_VERSION = SQ.MAXX
    where B.KEY_VERSION = SQ.MAXX AND B.KEY_TRANSACTION_ID = '201201'
    )
  </synKH>
  <synDM   >
    -------------------------------------------------
    -- 1 : KH_TAI_SAN_CO_DINH_HS_MAIN
    -------------------------------------------------
    (
    SELECT B.KEY_TRANSACTION_ID,
    LEFT(  B.KEY_TRANSACTION_ID,9) as BRANCH_CODE,
    SUBSTRING(B.KEY_TRANSACTION_ID,10,2)  YEAR,
    B.KEY_VERSION,
    B.TEN_TAI_SAN AS TEN_TS,B.DVT,B.DON_GIA,
    B.T1 T1,B.T2 T2,B.T3 T3,B.T4 T4,
    B.T5 T5,B.T6 T6,B.T7 T7,B.T8 T8,B.T9 T9,
    B.T10 T10,B.T11 T11,B.T12 T12
    ,B.TONG_SO_LUONG,B.THANH_TIEN,B.TY_LE_KHAU_HAO,B.CHI_PHI_TSCD
    ,SK.DATE,CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS ,
    SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER
    FROM  KH_TAI_SAN_CO_DINH_HS_MAIN B
    cross join
    (
    select TOP 1 KEY_TRANSACTION_ID
    --,KEY_VERSION
    ,DATE,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER
    from KH_TAI_SAN_CO_DINH_HS_TRANSACTION
    where  KEY_VERSION in (select max(key_version)
    from KH_TAI_SAN_CO_DINH_HS_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201')
    ------------------------------------
    -- CO NHIEU NGUOI SET TRANSACTION , LAY THOI DIEM MOI NHAT
    AND DATE = (SELECT TOP 1 DATE FROM KH_TAI_SAN_CO_DINH_HS_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201'
    ORDER BY DATE DESC)
    ) SK -- ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID
    --AND SK.KEY_VERSION = B.KEY_VERSION
    where  B.KEY_VERSION in (select max(key_version)
    from KH_TAI_SAN_CO_DINH_HS_TRANSACTION where STATUS = N'Đã duyệt'
    and KEY_TRANSACTION_ID = 'VN00114041201')
    and B.KEY_TRANSACTION_ID = 'VN00114041201'
    )
    -------------------------------------------------
    -- 2 : KH_TAI_SAN_CO_DINH_DON_VI_HIEN_TAI_MAIN
    -------------------------------------------------
    union all
    (
    SELECT B.KEY_TRANSACTION_ID,
    LEFT(  B.KEY_TRANSACTION_ID,9) as BRANCH_CODE,
    SUBSTRING(B.KEY_TRANSACTION_ID,10,2)  YEAR,
    B.KEY_VERSION,
    B.TEN_TAI_SAN AS TEN_TS,B.DVT,B.DON_GIA,
    B.SO_LUONG_THANG_1 T1,B.SO_LUONG_THANG_2 T2,B.SO_LUONG_THANG_3 T3,
    B.SO_LUONG_THANG_4 T4,
    B.SO_LUONG_THANG_5 T5,B.SO_LUONG_THANG_6 T6,B.SO_LUONG_THANG_7 T7,
    B.SO_LUONG_THANG_8 T8,B.SO_LUONG_THANG_9 T9,
    B.SO_LUONG_THANG_10 T10,B.SO_LUONG_THANG_11 T11,B.SO_LUONG_THANG_12 T12,
    B.TONG_SO_LUONG,B.THANH_TIEN,B.TY_LE_KHAU_HAO,B.CHI_PHI_TSCD,
    SK.DATE,CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS ,
    SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER
    FROM  KH_TAI_SAN_CO_DINH_DON_VI_HIEN_TAI_MAIN B
    cross join
    (
    select TOP 1 KEY_TRANSACTION_ID
    --,KEY_VERSION
    ,DATE,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER
    from KH_TAI_SAN_CO_DINH_DON_VI_HIEN_TAI_TRANSACTION
    where  KEY_VERSION in (select max(key_version)
    from KH_TAI_SAN_CO_DINH_DON_VI_HIEN_TAI_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201')
    AND DATE = (SELECT TOP 1 DATE FROM KH_TAI_SAN_CO_DINH_DON_VI_HIEN_TAI_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201'
    ORDER BY DATE DESC)
    ) SK -- ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID
    --AND SK.KEY_VERSION = B.KEY_VERSION
    where  B.KEY_VERSION in (select max(key_version) from KH_TAI_SAN_CO_DINH_DON_VI_HIEN_TAI_TRANSACTION where STATUS = N'Đã duyệt'
    and KEY_TRANSACTION_ID = 'VN00114041201')
    and B.KEY_TRANSACTION_ID = 'VN00114041201'

    )
    -------------------------------------------------
    -- 3 : KH_CONG_CU_LAO_DONG_HS_MAIN
    -------------------------------------------------
    union all
    (
    SELECT B.KEY_TRANSACTION_ID,
    LEFT(  B.KEY_TRANSACTION_ID,9) as BRANCH_CODE,
    SUBSTRING(B.KEY_TRANSACTION_ID,10,2)  YEAR,
    B.KEY_VERSION,
    B.DANH_MUC AS TEN_TS,B.DVT,B.KH_DON_GIA AS DON_GIA,
    B.T1_SL T1,B.T2_SL T2,B.T3_SL T3,
    B.T4_SL T4,
    B.T5_SL T5,B.T6_SL T6,B.T7_SL T7,
    B.T8_SL T8,B.T9_SL T9,
    B.T10_SL T10,B.T11_SL T11,B.T12_SL T12,
    B.KH_SO_LUONG TONG_SO_LUONG, B.KH_SO_LUONG *B.KH_DON_GIA THANH_TIEN,0 TY_LE_KHAU_HAO,0 CHI_PHI_TSCD,
    SK.DATE,CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS ,
    SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER
    FROM  KH_CONG_CU_LAO_DONG_HS_MAIN B
    cross join
    (
    select TOP 1 KEY_TRANSACTION_ID
    --,KEY_VERSION
    ,DATE,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER
    from KH_CONG_CU_LAO_DONG_HS_TRANSACTION
    where  KEY_VERSION in (select max(key_version)
    from KH_CONG_CU_LAO_DONG_HS_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201')
    AND DATE = (SELECT TOP 1 DATE FROM KH_CONG_CU_LAO_DONG_HS_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201'
    ORDER BY DATE DESC)
    ) SK -- ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID
    --AND SK.KEY_VERSION = B.KEY_VERSION
    where  B.KEY_VERSION in (select max(key_version) from KH_CONG_CU_LAO_DONG_HS_TRANSACTION where STATUS = N'Đã duyệt'
    and KEY_TRANSACTION_ID = 'VN00114041201')
    and B.KEY_TRANSACTION_ID = 'VN00114041201'

    )
    -------------------------------------------------
    -- 4 : KH_CONG_CU_LAO_DONG_MAIN
    -------------------------------------------------
    union all
    (
    SELECT B.KEY_TRANSACTION_ID,
    LEFT(  B.KEY_TRANSACTION_ID,9) as BRANCH_CODE,
    SUBSTRING(B.KEY_TRANSACTION_ID,10,2)  YEAR,
    B.KEY_VERSION,
    B.TEN_CONG_CU AS TEN_TS,B.DVT,B.DON_GIA,
    B.SO_LUONG T1,0 T2,0 T3,
    0 T4,
    0 T5,0 T6,0 T7,
    0 T8,0 T9,
    0 T10,0 T11,0 T12,
    B.SO_LUONG TONG_SO_LUONG, B.THANH_TIEN,0 TY_LE_KHAU_HAO,0 CHI_PHI_TSCD
    ,SK.DATE,CASE WHEN SK.STATUS = N'Đã duyệt' THEN 'A' ELSE 'U' END AS STATUS ,
    SK.KEY_INPUT_USER,SK.KEY_AUTHORISE_USER
    FROM  KH_CONG_CU_LAO_DONG_MAIN B
    cross join
    (
    select TOP 1 KEY_TRANSACTION_ID
    --,KEY_VERSION
    ,DATE,STATUS,KEY_INPUT_USER,KEY_AUTHORISE_USER
    from KH_CONG_CU_LAO_DONG_TRANSACTION
    where  KEY_VERSION in (select max(key_version)
    from KH_CONG_CU_LAO_DONG_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201')
    AND DATE = (SELECT TOP 1 DATE FROM KH_CONG_CU_LAO_DONG_TRANSACTION
    where STATUS = N'Đã duyệt'  and KEY_TRANSACTION_ID = 'VN00114041201'
    ORDER BY DATE DESC)
    ) SK -- ON SK.KEY_TRANSACTION_ID  =B.KEY_TRANSACTION_ID
    --AND SK.KEY_VERSION = B.KEY_VERSION
    where  B.KEY_VERSION in (select max(key_version) from KH_CONG_CU_LAO_DONG_TRANSACTION where STATUS = N'Đã duyệt'
    and KEY_TRANSACTION_ID = 'VN00114041201')
    and B.KEY_TRANSACTION_ID = 'VN00114041201'

    )
  </synDM>
</config>